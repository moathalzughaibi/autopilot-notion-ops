name: Ops Command Runner

on:
  workflow_dispatch:
    inputs:
      commands:
        description: "One or more commands (newline-separated)"
        required: true
        default: "LIST_ROOT_DBS"

jobs:
  run-ops:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: pip install requests
      - name: Run Ops Commands
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          ROOT_PAGE_ID: 29ab22c770d980918736f0dcad3bac83
          INPUT_COMMANDS: ${{ github.event.inputs.commands }}
        run: |
          python - <<'PY'
          import os, json, requests, re

          H={"Authorization":f"Bearer {os.environ['NOTION_TOKEN']}",
             "Notion-Version":"2022-06-28","Content-Type":"application/json"}
          ROOT=os.environ["ROOT_PAGE_ID"]
          CMD=[c.strip() for c in os.environ.get("INPUT_COMMANDS","").splitlines() if c.strip()]
          def _s(x): return re.sub(r'[^0-9a-fA-F]','',x)
          def create_db(t):
              p={"parent":{"type":"page_id","page_id":ROOT},
                 "title":[{"type":"text","text":{"content":t}}],
                 "properties":{"Name":{"title":{}}}}
              r=requests.post("https://api.notion.com/v1/databases",headers=H,data=json.dumps(p))
              if r.ok: print(f"[+] Created database '{t}': {_s(r.json()['id'])}")
              else: print(f"[!] Failed to create {t}: {r.status_code}->{r.text}")
          for c in CMD:
              if c.startswith("CREATE_DB"):
                  _,n=c.split(" ",1); create_db(n)
          PY
