name: IFNS Test Incident (Create & Notify)

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Incident title'
        required: true
        default: 'Export Failure - Heatmap Snapshot (Test)'
      severity:
        description: 'Severity select'
        required: true
        default: 'Action'
      incident_type:
        description: 'Incident Type select'
        required: true
        default: 'Export'
      summary:
        description: 'Summary rich text'
        required: true
        default: 'Test trigger for webhook'

jobs:
  create-and-notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install requests python-dateutil
      - name: Create Test Incident in Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          ROOT_PAGE_ID: ${{ secrets.ROOT_PAGE_ID }}
        run: |
          python scripts/create_test_incident.py             --title "${{ github.event.inputs.title }}"             --severity "${{ github.event.inputs.severity }}"             --type "${{ github.event.inputs.incident_type }}"             --summary "${{ github.event.inputs.summary }}"
      - name: Run Webhook Sender (Slack + Email)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          ROOT_PAGE_ID: ${{ secrets.ROOT_PAGE_ID }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python scripts/incident_webhook.py --config config/incident-webhook.json
